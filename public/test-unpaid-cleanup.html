<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Unpaid Registration Cleanup System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-clock me-2"></i>Test Unpaid Registration Cleanup System</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>System Overview</h5>
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-1"></i>How it works:</h6>
                                    <ul class="mb-0">
                                        <li><strong>Payment Reminders:</strong> Every 30 minutes for 6 hours</li>
                                        <li><strong>Auto Cleanup:</strong> Delete users after 6 hours without payment</li>
                                        <li><strong>WhatsApp Notifications:</strong> Automatic reminder and deletion messages</li>
                                        <li><strong>Queue System:</strong> 10-second delays between messages</li>
                                    </ul>
                                </div>
                                
                                <h5>Timeline Example</h5>
                                <div class="timeline">
                                    <div class="timeline-item">
                                        <span class="badge bg-success">0:00</span> User registers
                                    </div>
                                    <div class="timeline-item">
                                        <span class="badge bg-info">0:30</span> 1st reminder
                                    </div>
                                    <div class="timeline-item">
                                        <span class="badge bg-info">1:00</span> 2nd reminder
                                    </div>
                                    <div class="timeline-item">
                                        <span class="badge bg-warning">5:00</span> Last warning
                                    </div>
                                    <div class="timeline-item">
                                        <span class="badge bg-danger">6:00</span> Auto delete + notification
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Test Controls</h5>
                                
                                <div class="mb-3">
                                    <button class="btn btn-primary" onclick="checkUnpaidStatus()">
                                        <i class="fas fa-search me-1"></i>Check Unpaid Status
                                    </button>
                                    <button class="btn btn-warning" onclick="sendTestReminders()">
                                        <i class="fas fa-bell me-1"></i>Send Test Reminders
                                    </button>
                                    <button class="btn btn-danger" onclick="testCleanup()">
                                        <i class="fas fa-trash me-1"></i>Test Cleanup
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-info" onclick="openUnpaidMonitoring()">
                                        <i class="fas fa-monitor me-1"></i>Open Monitoring Dashboard
                                    </button>
                                    <button class="btn btn-secondary" onclick="openQueueManagement()">
                                        <i class="fas fa-cog me-1"></i>Queue Management
                                    </button>
                                </div>
                                
                                <div id="test-results" class="alert alert-secondary">
                                    Click buttons above to test the system.
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5>Manual Commands (for testing)</h5>
                                <div class="alert alert-dark">
                                    <h6>Laravel Artisan Commands:</h6>
                                    <code>php artisan registrations:process-unpaid</code><br>
                                    <code>php artisan registrations:process-unpaid --reminders</code><br>
                                    <code>php artisan registrations:process-unpaid --cleanup</code><br>
                                    <code>php artisan registrations:process-unpaid --dry-run</code>
                                </div>
                                
                                <h6>Scheduler Commands:</h6>
                                <div class="alert alert-warning">
                                    <p><strong>Auto Reminders:</strong> Every 5 minutes (checks for 30-minute intervals)</p>
                                    <p><strong>Auto Cleanup:</strong> Every 30 minutes</p>
                                    <p><strong>Start Scheduler:</strong> <code>php artisan schedule:work</code></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5>Current Unpaid Users</h5>
                                <div id="unpaid-users-table" class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Registered</th>
                                                <th>Time Elapsed</th>
                                                <th>Time Remaining</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="unpaid-users-tbody">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto refresh every 30 seconds
        setInterval(checkUnpaidStatus, 30000);
        
        // Initial load
        checkUnpaidStatus();

        function checkUnpaidStatus() {
            fetch('/admin/whatsapp-queue/unpaid-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateUnpaidTable(data.data);
                        updateTestResults(`
                            <div class="text-success">
                                <h6><i class="fas fa-check-circle me-1"></i>Status Updated</h6>
                                <p>Total Unpaid: ${data.data.total_unpaid}</p>
                                <p>Within 6 Hours: ${data.data.within_6_hours}</p>
                                <p>Over 6 Hours: ${data.data.over_6_hours}</p>
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    updateTestResults(`
                        <div class="text-danger">
                            <h6><i class="fas fa-times-circle me-1"></i>Error</h6>
                            <p>Failed to check status: ${error.message}</p>
                        </div>
                    `);
                });
        }

        function sendTestReminders() {
            updateTestResults(`
                <div class="text-info">
                    <i class="fas fa-spinner fa-spin me-1"></i>Sending test reminders...
                </div>
            `);
            
            fetch('/admin/whatsapp-queue/force-reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 'test'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTestResults(`
                        <div class="text-success">
                            <h6><i class="fas fa-check-circle me-1"></i>Reminders Sent</h6>
                            <p>Payment reminder job dispatched successfully</p>
                            <p>Check WhatsApp Queue for processing status</p>
                        </div>
                    `);
                } else {
                    updateTestResults(`
                        <div class="text-danger">
                            <h6><i class="fas fa-times-circle me-1"></i>Error</h6>
                            <p>${data.message}</p>
                        </div>
                    `);
                }
            })
            .catch(error => {
                updateTestResults(`
                    <div class="text-danger">
                        <h6><i class="fas fa-times-circle me-1"></i>Error</h6>
                        <p>Failed to send reminders: ${error.message}</p>
                    </div>
                `);
            });
        }

        function testCleanup() {
            if (confirm('⚠️ This will delete all registrations older than 6 hours!\n\nProceed with test cleanup?')) {
                updateTestResults(`
                    <div class="text-warning">
                        <i class="fas fa-spinner fa-spin me-1"></i>Running cleanup test...
                    </div>
                `);
                
                fetch('/admin/whatsapp-queue/force-cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 'test'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTestResults(`
                            <div class="text-success">
                                <h6><i class="fas fa-check-circle me-1"></i>Cleanup Started</h6>
                                <p>Cleanup job dispatched successfully</p>
                                <p>Users older than 6 hours will be deleted</p>
                            </div>
                        `);
                        setTimeout(checkUnpaidStatus, 3000); // Refresh after 3 seconds
                    } else {
                        updateTestResults(`
                            <div class="text-danger">
                                <h6><i class="fas fa-times-circle me-1"></i>Error</h6>
                                <p>${data.message}</p>
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    updateTestResults(`
                        <div class="text-danger">
                            <h6><i class="fas fa-times-circle me-1"></i>Error</h6>
                            <p>Failed to run cleanup: ${error.message}</p>
                        </div>
                    `);
                });
            }
        }

        function openUnpaidMonitoring() {
            window.open('/admin/unpaid-registrations', '_blank');
        }

        function openQueueManagement() {
            window.open('/admin/whatsapp-queue', '_blank');
        }

        function updateTestResults(html) {
            document.getElementById('test-results').innerHTML = html;
        }

        function updateUnpaidTable(data) {
            const tbody = document.getElementById('unpaid-users-tbody');
            tbody.innerHTML = '';
            
            if (data.users_by_time_remaining.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success">🎉 No unpaid registrations!</td></tr>';
            } else {
                data.users_by_time_remaining.forEach(user => {
                    const row = document.createElement('tr');
                    
                    let statusClass = 'success';
                    let statusText = 'Safe';
                    
                    if (user.minutes_elapsed > 300) {
                        statusClass = 'danger';
                        statusText = 'Critical';
                    } else if (user.minutes_elapsed > 240) {
                        statusClass = 'warning';
                        statusText = 'Warning';
                    } else if (user.minutes_elapsed > 180) {
                        statusClass = 'info';
                        statusText = 'Monitor';
                    }
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.registered_at}</td>
                        <td>${user.hours_elapsed}h</td>
                        <td>${user.time_remaining}</td>
                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
    </script>
    
    <style>
        .timeline {
            padding-left: 0;
        }
        .timeline-item {
            padding: 8px 0;
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
            margin-left: 10px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #dee2e6;
        }
        .timeline-item .badge {
            margin-right: 10px;
        }
    </style>
</body>
</html>
